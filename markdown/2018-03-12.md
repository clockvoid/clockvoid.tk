# Bonfire Androidのミートアップイベントに行ってきた話

<p class="date">2018-03-12</p>

本日Yahoo本社でBonfireのイベントをやっていたので行ってきました．今日のイベントについて発表の内容を含めてまとめてみます．

## 登壇1 Androidアプリにおけるソフトウェア設計の考え方
キーワード:OOAD，DDD

### アーキテクチャのおさらい
* MVC
    GUIに適用するとViewとContollerが密結合になりやすいらしい
* MVVM
    Modelを差分化するとViewModelが肥大化しやすいらしい
* Clean Archtecture
    レイヤードアーキテクチャ
    密結合にならないようにそうに分ける
    内部に行くほど，他のシステムに影響を受けないコードが書いてる．

### アプリ設計の考えかた
ビジネスロジックは環境に依存しない
ロジックのライフサイクルはコロコロ変わることがある
→UIとプラットフォームは分けたが，ビジネスロジックは整理されていない

* オブジェクト指向分析設計
    システムにあるあらゆるシステムの情報をモデル化する（SOLID原則）
* ドメイン駆動設計
    アプリで行いたいことをドメインと読んで，それをモデル化する．
    共通言語を用いる．
    名刺や同士がそれぞれクラスやメソッドに対応する
    設計書を見ればアプリの動作がわかる？

関心の分離をする．境界ごとにビジネスロジックを分離する．
→仕様変更が入っても，単一責任の原則を用いて上記と同じようにビジネスロジックを分けて追加すればすばやく対応可能．

### まとめ
アーキテクチャを採用しただけでは設計したとは言えず，ビジネスロジックや，プラットフォームを分けてしっかりと開発する必要がある．
これをやるためには，ドメイン駆動開発を採用してみるといいかもしれない．

## 課題感から始めるクラス設計と合意整形
AnyPay

* paymo
* paymo biz

てーま:サービと設計

### 設計について
* ガッチリクラス構成を考えている
* 基盤の部分だけを上の人が決める
* 全くわかっていない

いろんな設計パターンがあるよね
→全部課題があるから存在している！（偉い人が言ったから採用するものではない）

### 対策
* チームとしてできること
    今ある課題を解決できそうなパターンを使おう
    →課題がなければそんなに難しい設計を採用する必要はない．（それはそう）コスパを考えよう
* 個人的に最低限決めておいたほうがいいこと
    使うライブラリ使い方
    データアクセス処理の呼び出し方
    ビジネスロジックを書く場所

実装時にありがちな課題を知る
* 個人で0からアプリを作ってみる
* 何度もアップデートしてみる
* いろんな課題が見えてくるt
* 良かれと思った設計がつらみを生むこともあることを知りうる
* 設計に失敗した経験は一生の財産

### 実際に導入するとき
* 提案する
    1. 長期やSlackで周知する
    2. GitHubでIssueを建てる
* 具体例を見せる
    1. プルリク
    2. 議論
    3. Approveで合意をもらう
* リファクタを実装する

### 大事なこと
* 一人で突っ走らない

## 4年の開発が積み重なったアプリへのリファクタリング手法

### システムとチームを知る
Yahoo！ニュースアプリ
* アーキテクチャが採用されていなかった
* かなり闇が深そう
* エンジニアは三人

→早速リファクタしようではうまく行かない・・・

* サービスやシステムを知る
* チームを知る
* 今一応動いているコードをリスペクト

### 目指すことを明確に
* チームメンバーで重視すべき点を決める．
* いきなり学習コストを上げすぎない
* 決めた理由をドキュメントに残す
    →さっきのGitHubのIssueみたいな感じ．

### 設計や手法（具体例）
アーキテクチャはMVVM（ビジネスロジックはDomain，これはKotlinのDataクラスを用いているみたい．DI経験がないかららしい．）とリポジトリパターン

ActivityConteztはView層だけで用いる

粗結合にするためには，ViewModelがViewを知らないことと，Domainが他のオブジェクトに依存しないことが重要．

RxJavaのStreamをSubscribeっするのはViewだけ

### 結果
2ヶ月でトップ画面がリファクタ完了．

チームも変化

## 設計に見るAWAのAndroidアプリについて
テーマ:設計の来歴

### これまでの設計
はじめはMVCだった．エンジニアは1-4人
テストなし

→ビジネスロジックを書く層が必要！，Modelの責務を分割しなければ！

### リファクタ
Clean Archtecture Likeにリファクタ

data層のテストが充実した．

ModelをUseCaseとModelとDB Clientに

→結局問題が発生．何が問題だったのか？

設計のすり合わせを行ってこなかった．

### 1から作り直す！
どうするかいちから決め直した

リーダビリティ，てスタビリティ，メンテナンシビリティ

設計は可視化しよう

レイヤードアーキテクチャ*MVVM

CQRS

リポジトリを使う側からはデータソースを意識すべきではない
→APIはRepositoryのそとに置き，メソッドをあらためて作ってそこからRepositoryにアクセスする．

* CQRS
    コマンド（更新）とクエリ（取得）の責務を分離する
    コマンドでは副作用を発生するが，クエリは副作用を産まない．
    もはやそのレベルで副作用の集中化を図ってるみたい．

これでデータの流れが一定方向にできた！

## Yahoo! Japanアプリとレイヤードアーキテクチャ

### Yhaoo！ Japanアプリが抱えていた問題
* 大人数の開発で複数案件が同時並行で走る
* 明確な設計方針がない
* ユニットテストが書きづらい

### 設計の選択
* MV*
* PDS

PresetationとDomainを分ける！

→レイヤードアーキテクチャにする

### レイヤードアーキテクチャ
Presentation: View，ViewModel

↓

Application: Domainへの入り口

↓

Domain: ビジネスロジック

↓

Infrastructure: DBアクセス，API

* モジュールの分割を行った→図にない依存関係をコンパイルレベルで防げる

### スケジューリング
同一機能のリファクタリングと機能追加が同時に走らないようにスケジューリングする．

### 品質
Applicationレイヤー以下はユニットテストを義務化

### 諦めたこと
DI（Dagger2）の導入を諦めた

→どうやらDIはみんな学習コストが高いと感じるみたい．

### 成果
コードの見通しが良くなった

機能追加が簡単になった

メンバーの技術レベルが上がった

新規ジョインが簡単になった

### 維持
* コミッタ制度→PRを5/21のコミッタがレビューして，いいと思ったらマージ
* 使用共有会
* 設計レビュー会

### これから
AACの導入
