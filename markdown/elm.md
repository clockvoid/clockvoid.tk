# インターン選考技術課題でElmを初めて触ったので考察

<p class="date">2018-06-21</p>

とある企業さんのインターン選考課題でElmを初めて触ったので忘れないうちにその感想と技術的要旨をまとめてみます．

## Elmとは
Elmとは，HaskellっぽくかけるAltJSです．

Haskellのような文法を持ち，すべての変数はイミュータブルです．Web系とは信じられません．

基本的はほとんどHaskellと同じですが，やや異なっており，その微妙な違いに悩まされました．主な違いを挙げてみましょう．

* `Monad`がない
    状態はすべてElmアーキテクチャによって管理されるので，`Monad`がありません．しかし，Elmアーキテクチャが引き回す状態が文脈として働きますので，一応わかりやすいようにできています．
* 型クラスがない，少なくとも使わなかった
    型クラスのような硬度な型システムを使うまでもなく，Elmアーキテクチャがすべてを解決してくれます．
    ただし，別の型に作用する同名の関数がある場合，型クラスがないのでポリモーフィズが効かず，いちいち`(module name).(function)`とかやらないとだめなのが辛い
* 専門性が強い
    Haskellはどのような業務をもこなせるように作られている都合上，モナドなどの複雑な機構が必要ですが，ElmはSPAに充填をおいて作成されており，幾分かシンプルです．
    ただし，その文Elm独特の手法や，Elmアーキテクチャについてよく知っていなければまず扱うことができません．

## Elmアーキテクチャ
さっきからずっとElmアーキテクチャというワードが飛び交っていますが，これは一体何なのでしょう．

Haskellのモナドに専門性をもたせて機能を削ぎ落としたといえばそれまでですが，すこしだけその意図を覗いてみましょう．

まず，ElmアーキテクチャはModel View Updateなどという謎の構造をとっています．

Modelは文脈です．

Viewはその名の通り，ビューを宣言するものです．宣言的な文法が功を奏し，宣言的にかけるので，かなりきれいになります．某Reactとは違います．そういうとこだぞ．

UpdateはViewからのイベントを受けてModelを変化させます．この部分の動きが最も重要です．これ以外はすべて宣言的で単純明快ですから．
まず，Updateはイベントが発火されたときに呼び出されるようになっていますが，このときにMsgという型と文脈を取ります．このMsg（Messageのことです）によってどのイベントが発火されたかを知ります．
イベントの内容を知ることができたら，それぞれにあった方法で文脈を変化させます．イミュータブルですので，メモリをたくさん使ってコピーしまくります．安全です．
最終的に，Updateは更新された文脈と，コマンド（Cmd）がタプルになったものを返します．このコマンドで更にイベントを発火させたりすることができます．これは，返り値がElmによって処理されて，すべて自動でイベントの発火が行われるためです．非常に強力です．

更に，これらを補助するものとして，Subscription（無理に翻訳するならば，購読です．意味をなしませんので，Subscriptionと呼ぶことにしましょう．）というものがあります．おそらく定期的に呼び出されて，自動的に変化する外の状態を内へ取り込むためのものです．これがあることによって，受動的なアプリケーションをも作成することができます．

これをひとまとまりとして，ネストさせることができるため，まさにReactのTutorialに書いてある関数型アーキテクチャを表現できていることがわかります．
また，一つの文脈を操作によって変えていくという，まさにモナディックな構造が見て取れます．なんて美しいアーキテクチャなのでしょうか．

## Routing
基本的なアーキテクチャは前節で十分理解可能です．ではSPAに必要な独自の機能を見てみましょう．まずはRoutingです．

SPAですので，Routingは必須です．そのための機能として，Routingがあります．基本的にはチュートリアルに書いてることが全てです．適当にルートを決めて，それぞれにViewを設定し，ボタン等で移動したいときは`Navigation.newUrl : String -> Cmd msg`を使います．先程説明したコマンドを返しますので，`update`が呼び出されて所定の文脈操作が終わったあとにジャンプするなどの制御が可能です．

## Ports
次に，Portsについて見ていきましょう．

PortsはJavaScriptとElmでやり取りするための仕組みです．実はElmにはJavaScriptとやり取りするための仕組みがいくつか用意されており，NativeやPortsなどがその一例となりますが，私はPortsしか使ったことがありませんので，それ以外はよくわかりません．ただし，NativeはPortsの中身みたいなもので，Tutorialなどでは見ることのできない中核的な要素です．基本的にはNativeを扱うことはないでしょう．

### 使い方
Portsでは，`port module`としたモジュールをElm側に定義することから始めます．まずは，以下のようにモジュールを作ってみましょう．

```Elm
-- Port.elm
port module Port exposing (..)

port setSomething : String -> Cmd msg
port getSomething : (String -> msg) -> Sub msg
```

これができたら，JavaScript側に対応する動作を記述します．

```JavaScript
-- index.js

var app = Main.embed(document.getElementById("root"));
var someThing = "";

app.ports.getSomething.send(someThing); // call when something happend

app.ports.setSomething.subscription(function (str) { // call at regular intervals
    someThing = str;
});
```

だいたいこんな感じです，`send`でElmにデータを送っています．ここで，Elm側ではSubscriptionが生成される関数となっていますので，これはSubscriptionで受け取ります．
`subscription`でElmからデータを送っていますが，これも直感的でわかりやすいですね．これはElm側ではイベント時などでコマンドを実行する機会があるときにこの関数でコマンドを作ります．

## 最後に
今回はざっくりとまとめてみました．基本的にはチュートリアルを読んだ前提な感じになっていまいましたが，自分への備忘録的な側面が強いため，お許しください．

Elmで関数型SPA作成，凄まじい時代です．
